## 举例

这里建议你把80.class文件结构概述.md也一起打开来对照，或者excel，主要需要参考的是【常量类型和结构】的那张表

![image-20230505210558986](image/81.%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A7%A3%E8%AF%BB/image-20230505210558986.png)

我们先通过0A去找表中的数据，0A十六进制转十进制就是10

| 标志 | 常量                    | 描述               | 细节  | 长度 | 细节描述                                          |
| ---- | ----------------------- | ------------------ | ----- | ---- | ------------------------------------------------- |
| 10   | CONSTANT_Methodref_info | 类中方法的符号引用 | tag   | u1   | 值为10                                            |
|      |                         |                    | index | u2   | 指向声明方法的类描述符CONSTANT_Class_Info的索引项 |
|      |                         |                    | index | u2   | 指向名称及类型描述符CONSTANT_NameAndType的索引项  |

可以看到，第一位是tag，确实该值的类型，后面跟着长度为u2 + u2，就是长度为4，那么这个数据的总长度就是5

按照上面的方法，一直划到这里都没什么问题

![image-20230505211509544](image/81.%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A7%A3%E8%AF%BB/image-20230505211509544.png)

字符串有一些特别

| 标志 |        常量        |       描述        |  细节  | 长度 | 细节描述                        |
| :--- | :----------------: | :---------------: | :----: | ---- | ------------------------------- |
| 1    | CONSTANT_utf8_info | UTF-8编码的字符串 |  tag   | u1   | 值为1                           |
|      |                    |                   | length | u2   | UTF-8编码的字符串占用的字符数   |
|      |                    |                   | bytes  | u1   | 长度为length的UTF-8编码的字符串 |

tag之后的2位是用来记录字符串的长度的，例如上图，我们的字符串长度为3，那么从03之后都是字符串的

![image-20230505212154238](image/81.%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A7%A3%E8%AF%BB/image-20230505212154238.png)

知道了上面的规律，我们可以一直划到21，为什么是是21我们上面已经解释过了

![image-20230505213155582](image/81.%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A7%A3%E8%AF%BB/image-20230505213155582.png)

![image-20230505231354357](image/81.%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A7%A3%E8%AF%BB/image-20230505231354357.png)



## 符号引用

通过上面的标记，我们已经很快的找到了21的常量池中的数据，那么我们这里的数据可以和jclasslib中的常量池去一一对应

![image-20230505224518177](image/81.%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A7%A3%E8%AF%BB/image-20230505224518177.png)

【0A 00 04 00 12】
0A转换进制就是10
注意看我们的这个表格

![image-20230505230011973](image/81.%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A7%A3%E8%AF%BB/image-20230505230011973.png)

### 第一个

我们先看第一个u2，就是【指向声明方法的类描述符】
我们第一个u2对应数字是【00 04】， 那就是04，通过这个我们找04，就是【07 00 15】

![image-20230505231611747](image/81.%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A7%A3%E8%AF%BB/image-20230505231611747.png)

看这个【指向全限定名的常量项索引】，15转换十进制就是21

![image-20230505231452728](image/81.%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A7%A3%E8%AF%BB/image-20230505231452728.png)

21是字符串，具体就是ascii码转换，你可以参考下面的【字符串对应】，这里的21具体是【java/lang/Object】

![image-20230505230608382](image/81.%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A7%A3%E8%AF%BB/image-20230505230608382.png)

### 第二个

【00 12】，12转换进制就是18，去找18

![image-20230505231940060](image/81.%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A7%A3%E8%AF%BB/image-20230505231940060.png)

18是【0C 00 07 00 08】，0C进制转换之后是12

![image-20230505232037609](image/81.%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A7%A3%E8%AF%BB/image-20230505232037609.png)

第一个u2是【00 07】，第二个是【00 08】，对应的是

![image-20230505232148315](image/81.%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A7%A3%E8%AF%BB/image-20230505232148315.png)

两个都是字符串，我们去jclasslib里瞅瞅07和08都写了啥

<img src="image/81.%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A7%A3%E8%AF%BB/image-20230505232238362.png" alt="image-20230505232238362" style="zoom: 67%;" /><img src="image/81.%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A7%A3%E8%AF%BB/image-20230505232248501.png" alt="image-20230505232248501" style="zoom:67%;" />



可以看到 07是【<init>】，08是【()V】，凑一起就是【<<init> : ()V>】

我们看看01的jclasslib

![image-20230505232543663](image/81.%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A7%A3%E8%AF%BB/image-20230505232543663.png)

你看，一毛一样



## 字符串对应

看这个符号引用比较乱，我们看几个string

![image-20230505225220784](image/81.%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A7%A3%E8%AF%BB/image-20230505225220784.png)

1. 我们找到这个【01 00 09 ...】这一串，顺序是和jclasslib相对应的，而jclasslib对应的字符串是【Demo.java】，一共是9个字符
2. 我们去把第一位去进制转换，变成ascii，就是(16)44转换成(10)68，而68对应ascii码值就是D，后面的你可以自己依次比对

或者你可以直接去binary viewer里看，记得上面要选成text

![image-20230505232815987](image/81.%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A7%A3%E8%AF%BB/image-20230505232815987.png)



## 总结

- 这 14 种表（或者常量项结构）的共同点是：表开始的第一位是一个 u1 类型的标志位（tag），代表当前这个常量项使用的是哪种表结构，即哪种常量类型。
- 在常量池列表中，CONSTANT_Utf8_info 常量项是一种使用改进过的 UTF-8 编码格式来存储诸如文字字符串、类或者接口的全限定名、字段或者方法的简单名称以及描述符等常量字符串信息。
- 这 14 种常量项结构还有一个特点是，其中 13 个常量项占用的字节固定，只有 CONSTANT_Utf8_info 占用字节不固定，其大小由 length 决定。为什么？<font color="cyan">因为从常量池存放的内容可知，其存放的是字面量和符号引用，最终这些内容都会是一个字符串，这些字符串的大小是在编写程序时才确定，</font>比如你定义一个类，类名可以取长取短，所以在没编译前，大小不固定，编译后，通过 UTF-8 编码，就可以知道其长度。



- 常量池：可以理解为 Class 文件之中的资源仓库，它是 Class 文件结构中与其他项目关联最多的数据类型（后面的很多数据类型都会指向此处），也是占用 Class 文件空间最大的数据项目之一。
- 常量池中为什么包含这些内容？

  Java 代码在进行 javac 编译的时候，并不像 C 和 C++ 那样有"连接"这一步骤，而是在虚拟机加载 Class 文件的时候进行动态链接。也就是说，<font color="cyan">在 Class 文件中不会保存各个方法、字段的最终内存布局信息，因此这些字段、方法的符号引用不经过运行期转换的话无法得到真正的内存入口地址，也就无法直接被虚拟机使用。</font>当虚拟机运行时，需要从常量池获得对应的符号引用，再在类创建时或运行时解析、翻译到具体的内存地址之中。

